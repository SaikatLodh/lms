<!DOCTYPE html>
<html lang="en">
  <%- include('./layout/head.ejs') %>

  <body id="page-top">
    <div id="wrapper">
      <%- include('./layout/sidebar.ejs') %>

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
          <%- include('./layout/navbar.ejs') %> <% if(success && success.length
          > 0) { %>
          <div
            class="alert alert-success text-center alert-dismissible fade show success-msg"
            role="alert"
          >
            <%= success %>
            <button
              type="button"
              class="close"
              data-dismiss="alert"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <% } %> <% if(error && error.length > 0) { %>
          <div
            class="alert alert-danger text-center alert-dismissible fade show error-msg"
            role="alert"
          >
            <%= error %>
            <button
              type="button"
              class="close"
              data-dismiss="alert"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <% } %>

          <div class="container-fluid my-4">
            <div class="row">
              <div class="col-lg-6">
                <h1 class="h3 text-gray-800 mb-2">Manage Courses</h1>
                <h4 class="text-gray-800 mb-4 manage-size">
                  Total Courses:
                  <span id="total-courses-count"><%= courses.length %></span>
                </h4>
              </div>

              <div class="col-lg-6 d-flex justify-content-end">
                <div class="search-container position-relative">
                  <div>
                    <input
                      type="text"
                      id="course-search"
                      class="form-control border-primary"
                      placeholder="Search courses by title, description..."
                      aria-label="Search courses"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-4 mt-3 mt-md-0 mt-lg-0" id="courses-container">
              <% if (courses && courses.length > 0) { %> <%
              courses.forEach((course) => { %>
              <div class="col-12 col-md-6 col-lg-4 mb-5">
                <div class="card shadow-lg border-0 rounded-3 h-100">
                  <!-- Image -->
                  <img
                    src="<%= course.image.url %>"
                    class="card-img-top rounded-top"
                    alt="<%= course.title %>"
                    style="height: 200px; object-fit: cover"
                  />

                  <!-- Content -->
                  <div class="card-body d-flex flex-column">
                    <!-- Title -->
                    <h5 class="card-title fw-bold text-primary mb-2">
                      <%= course.title %>
                    </h5>

                    <!-- Subtitle -->
                    <h6 class="text-muted mb-3"><%= course.subtitle %></h6>

                    <!-- Category and Level -->
                    <p class="mb-1">
                      <span class="badge bg-info text-light me-2"
                        ><%= course.category %></span
                      >
                      <span class="badge bg-secondary text-white"
                        ><%= course.level %></span
                      >
                    </p>

                    <!-- Language -->
                    <p class="mb-1">
                      <strong>Language:</strong> <%= course.primaryLanguage %>
                    </p>

                    <!-- Instructor -->
                    <p class="mb-1">
                      <strong>Instructor:</strong> <%= course.instructorName %>
                    </p>

                    <!-- Pricing -->
                    <h6 class="text-success fw-bold mb-3">
                      â‚¹<%= course.pricing.toLocaleString() %>
                    </h6>

                    <!-- Buttons -->
                    <div class="mt-auto d-md-flex course-card">
                      <a
                        href="/managesinglecourses/<%= course._id %>"
                        class="btn btn-outline-primary btn-sm w-100 w-md-75 w-lg-50 mb-3 mb-md-0 mb-lg-0"
                      >
                        <i class="bi bi-pencil-square"></i> Edit
                      </a>
                      <form
                        action="/admin/deleteCourse/<%= course._id %>"
                        method="POST"
                        onsubmit="return confirm('Are you sure you want to delete this course?')"
                        class="w-100 w-md-75 w-lg-50 mb-3 mb-md-0 mb-lg-0"
                      >
                        <button
                          type="submit"
                          class="btn btn-outline-danger btn-sm w-100"
                        >
                          <i class="bi bi-trash"></i> Delete
                        </button>
                      </form>
                      <a
                        href="/managelectures/<%= course._id %>"
                        class="btn btn-outline-primary btn-sm w-100 w-md-75 w-lg-50 mb-3 mb-md-0 mb-lg-0"
                      >
                        <i class="bi bi-pencil-square"></i> Manage Lectures
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <% }); %> <% } else { %>
              <div class="col-12 text-center py-5">
                <div
                  class="d-flex flex-column align-items-center justify-content-center"
                >
                  <i
                    class="bi bi-book text-muted"
                    style="font-size: 4rem; margin-bottom: 1rem"
                  ></i>
                  <h4 class="text-muted mb-2">No Courses Found</h4>
                  <p class="text-muted">
                    There are no courses available at the moment.
                  </p>
                </div>
              </div>
              <% } %>
            </div>
          </div>
        </div>

        <%- include('./layout/footer.ejs') %>
      </div>
    </div>

    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="js/demo/datatables-demo.js"></script>

    <script>
      const successMessage = document.querySelector(".success-msg");
      const errorMessage = document.querySelector(".error-msg");

      if (successMessage) {
        setTimeout(function () {
          successMessage.style.display = "none";
        }, 5000);
      }

      if (errorMessage) {
        setTimeout(function () {
          errorMessage.style.display = "none";
        }, 5000);
      }
    </script>

    <script>
      (function () {
        const searchInput = document.getElementById("course-search");
        const clearBtn = document.getElementById("clear-search");
        const coursesContainer = document.getElementById("courses-container");
        const totalCountElem = document.getElementById("total-courses-count");

        function normalizeText(text) {
          return text.toLowerCase().trim();
        }

        function filterCourses() {
          const query = normalizeText(searchInput.value);
          const courseCards = coursesContainer.querySelectorAll(
            ".col-12.col-md-6.col-lg-4.mb-5"
          );
          let visibleCount = 0;

          courseCards.forEach((card) => {
            const title = normalizeText(
              card.querySelector(".card-title").textContent
            );
            const subtitle = normalizeText(
              card.querySelector("h6.text-muted.mb-3").textContent
            );
            const category = normalizeText(
              card.querySelector("p.mb-1 span.bg-info").textContent
            );
            const level = normalizeText(
              card.querySelector("p.mb-1 span.bg-secondary").textContent
            );
            const language = normalizeText(
              card
                .querySelector("p.mb-1 strong")
                .parentElement.textContent.replace("Language:", "")
            );
            const instructor = normalizeText(
              card
                .querySelector("p.mb-1 strong")
                .parentElement.textContent.replace("Instructor:", "")
            );

            const combinedText =
              title +
              " " +
              subtitle +
              " " +
              category +
              " " +
              level +
              " " +
              language +
              " " +
              instructor;

            if (combinedText.includes(query)) {
              card.style.display = "";
              visibleCount++;
            } else {
              card.style.display = "none";
            }
          });

          totalCountElem.textContent = visibleCount;
        }

        searchInput.addEventListener("input", () => {
          filterCourses();
          clearBtn.style.display = searchInput.value ? "inline-block" : "none";
        });

        clearBtn.addEventListener("click", () => {
          searchInput.value = "";
          filterCourses();
          clearBtn.style.display = "none";
          searchInput.focus();
        });
      })();
    </script>
  </body>
</html>
